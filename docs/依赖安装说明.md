# 依赖安装说明

本文档整理 iSPA/ADaM 解析等功能所需依赖（pandas、pyreadstat）的安装步骤及常见问题处理。

---

## 1. 安装 pandas

### 1.1 基本安装

```powershell
pip install pandas
```

### 1.2 若出现权限错误（WinError 5 拒绝访问）

报错示例：

```
ERROR: Could not install packages due to an OSError: [WinError 5] 拒绝访问。: 'C:\Users\...\AppData\Roaming\Python'
```

**解决方式（任选其一）：**

- **方式 A：以管理员身份安装**  
  右键“命令提示符”或“PowerShell” → “以管理员身份运行”，再执行：
  ```powershell
  pip install pandas
  ```

- **方式 B：使用项目虚拟环境（推荐）**  
  在项目目录下执行：
  ```powershell
  python -m venv venv
  .\venv\Scripts\activate
  pip install pandas
  ```

---

## 2. 安装 pyreadstat

用于读取 SAS 数据集（如 `.sas7bdat`），EDCDEF 等流程会用到。

### 2.1 优先使用预编译包（推荐）

可避免本地编译，无需安装 Visual C++ 构建工具：

```powershell
pip install --upgrade pip
pip install pyreadstat --only-binary :all: --timeout 120
```

- `--only-binary :all:`：只使用 wheel，不从源码编译。  
- `--timeout 120`：拉长超时，减少网络不稳定导致的失败。

### 2.2 若出现 “Microsoft Visual C++ 14.0 or greater is required”

说明 pip 下载到的是源码包并在本地编译，需要 C++ 构建工具。

**处理顺序：**

1. 先升级 pip 并强制使用预编译包（见 2.1）。  
2. 若仍从源码编译，再安装构建工具：  
   - 打开：<https://visualstudio.microsoft.com/visual-cpp-build-tools/>  
   - 下载并安装 **Build Tools for Visual Studio**  
   - 安装时勾选工作负载 **“使用 C++ 的桌面开发”**  
   - 安装完成后重新打开命令行，再执行：`pip install pyreadstat`

### 2.3 若出现网络超时（ReadTimeoutError）或 setuptools 找不到

报错示例：

- `ReadTimeoutError: HTTPSConnectionPool(host='pypi.org', port=443): Read timed out`
- `ERROR: Could not find a version that satisfies the requirement setuptools`

**处理步骤：**

1. **先安装/升级 setuptools（并拉长超时）：**
   ```powershell
   pip install --upgrade setuptools --timeout 120
   ```
   若访问 PyPI 较慢，可使用国内镜像：
   ```powershell
   pip install --upgrade setuptools -i https://pypi.tuna.tsinghua.edu.cn/simple --timeout 120
   ```

2. **再安装 pyreadstat（仅二进制 + 镜像 + 超时）：**
   ```powershell
   pip install pyreadstat --only-binary :all: -i https://pypi.tuna.tsinghua.edu.cn/simple --timeout 120
   ```

3. **（可选）永久提高 pip 超时时间：**
   ```powershell
   pip config set global.timeout 120
   ```

---

## 3. 一键顺序（推荐）

在**网络可能较慢或曾出现超时**的情况下，可按下面顺序执行：

```powershell
pip install --upgrade pip
pip install --upgrade setuptools -i https://pypi.tuna.tsinghua.edu.cn/simple --timeout 120
pip install pandas -i https://pypi.tuna.tsinghua.edu.cn/simple --timeout 120
pip install pyreadstat --only-binary :all: -i https://pypi.tuna.tsinghua.edu.cn/simple --timeout 120
```

若之前安装 pandas 时出现权限错误，请先以**管理员身份**打开 PowerShell，或使用**虚拟环境**（见 1.2），再执行上述命令。

---

## 4. 验证安装

```powershell
python -c "import pandas; print('pandas:', pandas.__version__)"
python -c "import pyreadstat; print('pyreadstat OK')"
```

无报错即表示安装成功。
